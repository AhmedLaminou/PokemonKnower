{% extends "base.html" %}

{% block title %}Who's That Pokémon? | Pokémon Knower{% endblock %}

{% block content %}
<div class="quiz-page">
    <div class="page-header">
        <h1><i class="fas fa-question-circle"></i> Who's That Pokémon?</h1>
        <p>Test your Pokémon knowledge!</p>
    </div>

    <!-- Quiz Container -->
    <div class="quiz-container" id="quizContainer">
        <!-- Start Screen -->
        <div class="quiz-screen" id="startScreen">
            <div class="quiz-card start-card">
                <i class="fas fa-gamepad quiz-icon"></i>
                <h2>Ready to Test Your Knowledge?</h2>
                <p>You'll see a silhouette and need to guess the Pokémon!</p>
                <div class="quiz-options">
                    <label>Number of Questions:</label>
                    <select id="questionCount">
                        <option value="5">5 Questions</option>
                        <option value="10" selected>10 Questions</option>
                        <option value="20">20 Questions</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-lg" onclick="startQuiz()">
                    <i class="fas fa-play"></i> Start Quiz
                </button>
            </div>
        </div>

        <!-- Question Screen -->
        <div class="quiz-screen" id="questionScreen" style="display: none;">
            <div class="quiz-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <span id="progressText">1 / 10</span>
            </div>

            <div class="quiz-card question-card">
                <div class="pokemon-silhouette" id="silhouetteContainer">
                    <img id="pokemonImage" src="" alt="Who's That Pokémon?">
                </div>
                <h2>Who's That Pokémon?</h2>
                <div class="answer-options" id="answerOptions"></div>
            </div>

            <div class="quiz-score-display">
                <span>Score: <strong id="currentScore">0</strong></span>
            </div>
        </div>

        <!-- Result Screen -->
        <div class="quiz-screen" id="resultScreen" style="display: none;">
            <div class="quiz-card result-card">
                <div class="result-icon" id="resultIcon">
                    <i class="fas fa-trophy"></i>
                </div>
                <h2 id="resultTitle">Quiz Complete!</h2>
                <div class="result-score">
                    <span class="score-number" id="finalScore">0</span>
                    <span class="score-total">/ <span id="totalQuestions">10</span></span>
                </div>
                <p id="resultMessage"></p>
                <div class="result-actions">
                    <button class="btn btn-primary" onclick="startQuiz()">
                        <i class="fas fa-redo"></i> Play Again
                    </button>
                    <a href="{{ url_for('pokedex') }}" class="btn btn-secondary">
                        <i class="fas fa-book-open"></i> Browse Pokédex
                    </a>
                </div>
            </div>

            <!-- Leaderboard -->
            <div class="leaderboard-section">
                <h3><i class="fas fa-medal"></i> Top Scores</h3>
                <div class="leaderboard" id="leaderboard"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .quiz-page {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .page-header h1 i {
        color: var(--pokemon-yellow);
    }

    .quiz-screen {
        animation: fadeIn 0.3s ease;
    }

    .quiz-card {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: 2rem;
        text-align: center;
    }

    .start-card .quiz-icon {
        font-size: 4rem;
        color: var(--pokemon-yellow);
        margin-bottom: 1rem;
    }

    .start-card h2 {
        margin-bottom: 0.5rem;
    }

    .start-card p {
        color: var(--text-muted);
        margin-bottom: 1.5rem;
    }

    .quiz-options {
        margin-bottom: 1.5rem;
    }

    .quiz-options label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
    }

    .quiz-options select {
        padding: 0.75rem 1.5rem;
        background: var(--bg-darker);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 1rem;
    }

    .btn-lg {
        padding: 1rem 2rem;
        font-size: 1.1rem;
    }

    .quiz-progress {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .progress-bar {
        flex: 1;
        height: 8px;
        background: var(--bg-card);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: var(--gradient-pokemon);
        transition: width 0.3s ease;
    }

    #progressText {
        color: var(--text-secondary);
        min-width: 60px;
    }

    .pokemon-silhouette {
        width: 250px;
        height: 250px;
        margin: 0 auto 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-darker);
        border-radius: var(--radius-lg);
        position: relative;
        overflow: hidden;
    }

    .pokemon-silhouette img {
        max-width: 80%;
        max-height: 80%;
        filter: brightness(0);
        transition: filter 0.5s ease;
    }

    .pokemon-silhouette.revealed img {
        filter: brightness(1);
    }

    .question-card h2 {
        margin-bottom: 1.5rem;
    }

    .answer-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .answer-btn {
        padding: 1rem;
        background: var(--bg-darker);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .answer-btn:hover:not(:disabled) {
        border-color: var(--pokemon-yellow);
        background: rgba(255, 203, 5, 0.1);
    }

    .answer-btn.correct {
        border-color: #4ade80;
        background: rgba(74, 222, 128, 0.2);
        color: #4ade80;
    }

    .answer-btn.wrong {
        border-color: #f87171;
        background: rgba(248, 113, 113, 0.2);
        color: #f87171;
    }

    .answer-btn:disabled {
        cursor: not-allowed;
    }

    .quiz-score-display {
        margin-top: 1.5rem;
        color: var(--text-secondary);
    }

    .quiz-score-display strong {
        color: var(--pokemon-yellow);
        font-size: 1.25rem;
    }

    .result-card {
        margin-bottom: 2rem;
    }

    .result-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .result-icon.excellent { color: #ffd700; }
    .result-icon.good { color: #c0c0c0; }
    .result-icon.average { color: #cd7f32; }
    .result-icon.poor { color: var(--text-muted); }

    .result-score {
        margin: 1.5rem 0;
    }

    .score-number {
        font-size: 4rem;
        font-weight: 800;
        color: var(--pokemon-yellow);
    }

    .score-total {
        font-size: 2rem;
        color: var(--text-muted);
    }

    #resultMessage {
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
    }

    .result-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .leaderboard-section {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
    }

    .leaderboard-section h3 {
        margin-bottom: 1rem;
        text-align: center;
    }

    .leaderboard-section h3 i {
        color: #ffd700;
    }

    .leaderboard-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: var(--bg-darker);
        border-radius: var(--radius-sm);
        margin-bottom: 0.5rem;
    }

    .leaderboard-rank {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
    }

    .leaderboard-rank.gold { background: #ffd700; color: #333; }
    .leaderboard-rank.silver { background: #c0c0c0; color: #333; }
    .leaderboard-rank.bronze { background: #cd7f32; color: #fff; }

    .leaderboard-name { flex: 1; }
    .leaderboard-score { font-weight: 700; color: var(--pokemon-yellow); }

    @media (max-width: 600px) {
        .answer-options {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentQuestion = 0;
let score = 0;
let totalQuestions = 10;
let questions = [];

async function startQuiz() {
    totalQuestions = parseInt(document.getElementById('questionCount').value);
    currentQuestion = 0;
    score = 0;
    questions = [];

    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('resultScreen').style.display = 'none';
    document.getElementById('questionScreen').style.display = 'block';
    
    document.getElementById('currentScore').textContent = '0';
    
    await loadQuestion();
}

async function loadQuestion() {
    try {
        const response = await fetch('/api/quiz/question');
        const data = await response.json();
        
        questions.push(data);
        displayQuestion(data);
    } catch (error) {
        console.error('Error loading question:', error);
    }
}

function displayQuestion(data) {
    document.getElementById('progressFill').style.width = `${((currentQuestion) / totalQuestions) * 100}%`;
    document.getElementById('progressText').textContent = `${currentQuestion + 1} / ${totalQuestions}`;
    
    const silhouette = document.getElementById('silhouetteContainer');
    silhouette.classList.remove('revealed');
    
    const img = document.getElementById('pokemonImage');
    img.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${data.pokemon_number}.png`;
    
    const optionsContainer = document.getElementById('answerOptions');
    optionsContainer.innerHTML = data.options.map(opt => 
        `<button class="answer-btn" onclick="selectAnswer(${opt.id}, ${data.pokemon_id}, '${opt.name}')">${opt.name}</button>`
    ).join('');
}

function selectAnswer(selectedId, correctId, selectedName) {
    const buttons = document.querySelectorAll('.answer-btn');
    buttons.forEach(btn => {
        btn.disabled = true;
        if (btn.textContent === selectedName) {
            btn.classList.add(selectedId === correctId ? 'correct' : 'wrong');
        }
        // Show correct answer
        const correctPokemon = questions[currentQuestion].options.find(o => o.id === correctId);
        if (correctPokemon && btn.textContent === correctPokemon.name) {
            btn.classList.add('correct');
        }
    });
    
    // Reveal Pokemon
    document.getElementById('silhouetteContainer').classList.add('revealed');
    
    if (selectedId === correctId) {
        score++;
        document.getElementById('currentScore').textContent = score;
    }
    
    currentQuestion++;
    
    setTimeout(() => {
        if (currentQuestion < totalQuestions) {
            loadQuestion();
        } else {
            showResults();
        }
    }, 1500);
}

async function showResults() {
    document.getElementById('questionScreen').style.display = 'none';
    document.getElementById('resultScreen').style.display = 'block';
    
    document.getElementById('finalScore').textContent = score;
    document.getElementById('totalQuestions').textContent = totalQuestions;
    
    const percentage = (score / totalQuestions) * 100;
    const resultIcon = document.getElementById('resultIcon');
    let message = '';
    
    if (percentage >= 90) {
        resultIcon.innerHTML = '<i class="fas fa-trophy"></i>';
        resultIcon.className = 'result-icon excellent';
        message = 'Incredible! You\'re a true Pokémon Master!';
    } else if (percentage >= 70) {
        resultIcon.innerHTML = '<i class="fas fa-medal"></i>';
        resultIcon.className = 'result-icon good';
        message = 'Great job! You know your Pokémon!';
    } else if (percentage >= 50) {
        resultIcon.innerHTML = '<i class="fas fa-star"></i>';
        resultIcon.className = 'result-icon average';
        message = 'Not bad! Keep training!';
    } else {
        resultIcon.innerHTML = '<i class="fas fa-book-open"></i>';
        resultIcon.className = 'result-icon poor';
        message = 'Time to study the Pokédex!';
    }
    
    document.getElementById('resultMessage').textContent = message;
    
    // Submit score
    try {
        await fetch('/api/quiz/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ score, total: totalQuestions })
        });
    } catch (e) {}
    
    // Load leaderboard
    loadLeaderboard();
}

async function loadLeaderboard() {
    try {
        const response = await fetch('/api/quiz/leaderboard');
        const data = await response.json();
        
        const container = document.getElementById('leaderboard');
        if (data.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No scores yet. Be the first!</p>';
            return;
        }
        
        container.innerHTML = data.slice(0, 10).map((s, i) => `
            <div class="leaderboard-item">
                <span class="leaderboard-rank ${i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : ''}">${i + 1}</span>
                <span class="leaderboard-name">${s.user_name}</span>
                <span class="leaderboard-score">${s.percentage}%</span>
            </div>
        `).join('');
    } catch (e) {
        console.error('Leaderboard error:', e);
    }
}
</script>
{% endblock %}
